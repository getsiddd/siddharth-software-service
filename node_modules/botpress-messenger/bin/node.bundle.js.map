{"version":3,"sources":["webpack:///webpack/bootstrap 8ba45cfdd67db91a6eff","webpack:///./src/index.js","webpack:///external \"botpress-version-manager\"","webpack:///external \"path\"","webpack:///external \"fs\"","webpack:///external \"lodash\"","webpack:///external \"uuid\"","webpack:///external \"bluebird\"","webpack:///./src/messenger.js","webpack:///./src/db.js","webpack:///external \"botpress\"","webpack:///external \"eventemitter2\"","webpack:///external \"crypto\"","webpack:///external \"node-fetch\"","webpack:///external \"body-parser\"","webpack:///./src/actions.js","webpack:///./src/outgoing.js","webpack:///./src/incoming.js","webpack:///external \"lru-cache\"","webpack:///./src/users.js","webpack:///./src/umm.js","webpack:///external \"util\"","webpack:///./src/botpress-messenger.config.yml"],"names":["messenger","outgoingPending","pending","users","outgoingMiddleware","event","next","platform","type","setValue","args","__id","message_id","timestamp","Date","getTime","mid","method","raw","waitDelivery","waitRead","apply","then","initializeMessenger","bp","configurator","loadAll","config","configErrors","getConfigErrors","enabled","logger","warn","length","err","message","notifications","send","level","connect","updateSettings","catch","error","createConfigFile","name","file","join","projectLocation","existsSync","writeFileSync","module","exports","applicationID","required","default","env","accessToken","appSecret","verifyToken","v4","validated","connected","hostname","homepage","displayGetStarted","greetingMessage","persistentMenu","persistentMenuItems","validation","isArray","v","composerInputDisabled","automaticallyMarkAsRead","targetAudience","targetAudienceOpenToSome","targetAudienceCloseToSome","trustedDomains","autoRespondGetStarted","autoResponse","autoResponseOption","autoResponseText","autoResponsePostback","paymentTesters","chatExtensionHomeUrl","chatExtensionInTest","chatExtensionShowShareButton","webhookSubscriptionFields","init","__dirname","middlewares","register","order","handler","description","forIn","action","applyFn","msg","arguments","promise","_promise","fn","deprecate","lts","referenceUrl","sendName","replace","sendOutgoing","ready","_internal","router","getRouter","get","req","res","getConfig","post","setConfig","body","saveAll","sendStatus","status","disconnect","sendValidationRequest","json","packageJSON","JSON","parse","readFileSync","getAllUsers","values","deletePaymentTester","payment_tester","_getPage","Promise","require","EventEmitter","crypto","fetch","_","bodyParser","normalizeString","str","toUpperCase","db","Messenger","Error","k","initialize","app","test","originalUrl","use","verify","_verifyRequestSignature","bind","_initWebhook","Object","assign","errors","forEach","value","key","includes","isNil","isEmpty","push","_setupNewWebhook","_subscribePage","_unsubscribePage","recipientId","text","quickReplies","options","formattedQuickReplies","_formatQuickReplies","quick_replies","sendMessage","buttons","payload","template_type","formattedButtons","_formatButtons","sendTemplate","elements","attachment","url","isReusable","isBoolean","is_reusable","attachmentId","attachment_id","hasAttachment","getAttachment","addAttachment","sendRequest","recipient","id","sender_action","typing","autoTimeout","timeout","sendTypingIndicator","headers","stringify","object_id","object","field","custom_fields","page_id","access_token","_handleFacebookResponse","endpoint","_handleEvent","token","response","milliseconds","isNaN","Math","min","before","resolve","sendAction","delay","userId","console","log","setting","target_audience","audience_type","countriesWhitelist","split","countries","whitelist","countriesBlacklist","blacklist","createTargetAudienceSetting","domains","indexOf","setting_type","whitelisted_domains","domain_action_type","sendThreadRequest","greeting","on","thread_state","call_to_actions","persistent_menu","locale","composer_input_disabled","home_url","in_test","show_share","show_string","deleteChatExtensionHomeUrlSetting","createChatExtensionHomeUrlSetting","tester","createPaymentTesterSetting","deletePaymentTesterSetting","updateGetStarted","setGetStartedButton","deleteGetStartedButton","updateGreetingText","deleteGreetingText","setGreetingText","items","_reformatPersistentMenuItems","updatePersistentMenu","setPersistentMenu","deletePersistentMenu","updateTargetAudience","setTargetAudience","updateTrustedDomains","setWhitelistedDomains","updateChatExtensionHomeUrl","deleteChatExtensionHomeUrl","setChatExtensionHomeUrl","updatePaymentTesters","setPaymentTesters","thrown","contextifyError","context","factory","map","button","title","reply","content_type","image_url","emit","sender","postback","quick_reply","errorMessage","statusText","finally","query","data","entry","messaging","is_echo","broadcastEchoes","_handleQuickReplyEvent","_handleMessageEvent","attachments","_handleAttachmentEvent","_handlePostbackEvent","delivery","read","account_linking","optin","referral","payment","buf","path","signature","hash","expectedHash","createHmac","update","digest","item","oAuthUrl","callback_url","verify_token","fields","knex","createTableIfNotExists","table","string","primary","insert","where","select","ret","count","create","reject","r","rj","messageId","toISOString","random","newEvent","_resolve","_reject","obj","validateUserId","validateText","validateQuickReplies","validateQuickReply","validateTyping","isNumber","validateAttachmentType","toLowerCase","validateUrl","validateTemplatePayload","isPlainObject","validatePersistentMenu","element","createText","to","createAttachment","isNull","createTemplate","createTyping","createSeen","createPersistentMenu","delete","createGreetingText","createGetStarted","createWhitelistedDomains","every","isString","handlePromise","handleText","sendTextMessage","handleAttachment","sendAttachment","handleTemplate","handleTyping","handleSeen","handleGetStarted","handlePersistentMenu","handleGreetingText","handleWhitelistedDomains","messagesCache","max","maxAge","preprocessEvent","has","alreadyProcessed","set","getOrFetchUserProfile","e","sendIncoming","user","profile","att","mConfig","sendText","mids","watermark","toString","ref","dbEntryToProfile","getUserProfile","saveUser","profileToDbEntry","gender","timezone","picture_url","profile_pic","first_name","last_name","QUICK_REPLY_PAYLOAD","processButtons","blocName","processQuickReplies","qrs","qr","exec","startsWith","amendButtons","mapValues","getUserId","substr","processOutgoing","instruction","ins","optionsList","pick","prop","attr","strRep","inspect","getTemplates","template","at","umm","registerConnector","templates"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/Users/slvn/Desktop/botpress-messenger\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 8ba45cfdd67db91a6eff","/* global __dirname */\n\nimport checkVersion from 'botpress-version-manager'\n\nimport path from 'path'\nimport fs from 'fs'\nimport _ from 'lodash'\n\nimport uuid from 'uuid'\nimport Promise from 'bluebird'\n\nimport Messenger from './messenger'\nimport actions from './actions'\nimport outgoing from './outgoing'\nimport incoming from './incoming'\nimport Users from './users'\nimport UMM from './umm'\n\nimport configTemplate from 'raw!./botpress-messenger.config.yml'\n\nlet messenger = null\nconst outgoingPending = outgoing.pending\n\nlet users = null\n\nconst outgoingMiddleware = (event, next) => {\n  if (event.platform !== 'facebook') {\n    return next()\n  }\n\n  if (!outgoing[event.type]) {\n    return next('Unsupported event type: ' + event.type)\n  }\n\n  const setValue = method => (...args) => {\n    if (event.__id && outgoingPending[event.__id]) {\n\n      if (args && args[0] && args[0].message_id) {\n        outgoingPending[event.__id].timestamp = new Date().getTime() - 1000\n        outgoingPending[event.__id].mid = args[0].message_id\n      }\n\n      if (method === 'resolve' && (event.raw.waitDelivery || event.raw.waitRead)) {\n        // We skip setting this value because we wait\n      } else {\n        outgoingPending[event.__id][method].apply(null, args)\n        delete outgoingPending[event.__id]\n      }\n    }\n  }\n\n  outgoing[event.type](event, next, messenger)\n  .then(setValue('resolve'), setValue('reject'))\n}\n\nconst initializeMessenger = (bp, configurator) => {\n  return configurator.loadAll()\n  .then(config => {\n    messenger = new Messenger(bp, config)\n\n    users = Users(bp, messenger)\n\n    const configErrors = messenger.getConfigErrors()\n    const enabled = config.enabled\n\n    if (!enabled) {\n      return bp.logger.warn('[botpress-messenger] Connection disabled.')\n    }\n\n    if (configErrors.length) {\n      for (var err of configErrors) {\n        bp.logger.warn('[botpress-messenger] ' + err.message)\n      }\n\n      return bp.notifications.send({\n        level: 'error',\n        message: 'Error updating Messenger App. Please see logs for details.'\n      })\n    }\n\n    return messenger.connect()\n    .then(() => messenger.updateSettings())\n    .then(() => bp.notifications.send({\n      level: 'success',\n      message: 'Configuration and webhook updated'\n    }))\n    .catch(err => {\n      bp.logger.error(err)\n      return bp.notifications.send({\n        level: 'error',\n        message: 'Error updating Messenger App. Please see logs for details.'\n      })\n    })\n\n  })\n}\n\nconst createConfigFile = (bp) => {\n  const name = 'botpress-messenger.config.yml'\n  const file = path.join(bp.projectLocation, name)\n\n  if (!fs.existsSync(file)) {\n    fs.writeFileSync(file, configTemplate)\n\n    bp.notifications.send({\n      level: 'info',\n      message: name + ' has been created, fill it'\n    })\n  }\n}\n\nmodule.exports = {\n\n  config: {\n    applicationID: { type: 'string', required: true, default: '', env: 'MESSENGER_APP_ID' },\n    accessToken: { type: 'string', required: true, default: '', env: 'MESSENGER_ACCESS_TOKEN' },\n    appSecret: { type: 'string', required: true, default: '', env: 'MESSENGER_APP_SECRET' },\n    verifyToken: { type: 'string', required: false, default: uuid.v4() },\n    enabled: { type: 'bool', required: true, default: true },\n    validated: { type: 'bool', required: false, default: false }, // deprecated --> automaticcaly reconfigure on start (config = enabled)\n    connected: { type: 'bool', required: false, default: false }, // deprecated --> automaticcaly reconfigure on start (config = enabled)\n    hostname: { type: 'string', required: false, default: '', env: 'MESSENGER_HOST' },\n    homepage: { type: 'string' },\n    displayGetStarted: { type: 'bool', required: false, default: true },\n    greetingMessage: { type: 'string', required: false, default: 'Default greeting message' },\n    persistentMenu: { type: 'bool', required: false, default: false },\n    persistentMenuItems: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\n    composerInputDisabled: { type: 'bool', required: false, default: false },\n    automaticallyMarkAsRead: { type: 'bool', required: false, default: true },\n    targetAudience: { type: 'string', required: true, default: 'openToAll'},\n    targetAudienceOpenToSome: { type: 'string', required: false },\n    targetAudienceCloseToSome: { type: 'string', required: false },\n    trustedDomains: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\n    autoRespondGetStarted: { type: 'bool', required: false, default: true }, // deprecated\n    autoResponse: { type: 'string', required: false, default: 'Hello!' },     // deprecated\n    autoResponseOption: { type: 'string', required: false, default: 'autoResponseText' },\n    autoResponseText: { type: 'string', required: false, default: 'Hello, human!' },\n    autoResponsePostback: { type: 'string', required: false, default: 'YOUR_POSTBACK' },\n    paymentTesters: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\n    chatExtensionHomeUrl: { type: 'string', required: false, default: '' },\n    chatExtensionInTest: { type: 'bool', required: false, default: true },\n    chatExtensionShowShareButton: { type: 'bool', required: false, default: false },\n    webhookSubscriptionFields: { \n      type: 'any', \n      required: true, \n      default: [\n        'message_deliveries',\n        'message_reads',\n        'messages',\n        'messaging_optins',\n        'messaging_postbacks',\n        'messaging_referrals'\n      ]\n    }\n  },\n\n  init: function(bp) {\n\n    checkVersion(bp, __dirname)\n\n    bp.middlewares.register({\n      name: 'messenger.sendMessages',\n      type: 'outgoing',\n      order: 100,\n      handler: outgoingMiddleware,\n      module: 'botpress-messenger',\n      description: 'Sends out messages that targets platform = messenger.' +\n      ' This middleware should be placed at the end as it swallows events once sent.'\n    })\n\n    bp.messenger = {}\n    _.forIn(actions, (action, name) => {\n\n      const applyFn = fn => function() {\n        var msg = action.apply(this, arguments)\n        const promise = msg._promise\n        return fn && fn(msg, promise)\n      }\n\n      const deprecate = fn => function() {\n        return (bp.lts && bp.lts.deprecate({\n          module: 'botpress-messenger',\n          message: 'create___ and send___ methods have been deprecated in favor of UMM and will be officially removed in Botpress v2.0',\n          referenceUrl: 'https://botpress.io/docs/foundamentals/umm.html'\n        }, fn)) || fn.apply(this, arguments)\n      }\n\n      var sendName = name.replace(/^create/, 'send')\n      bp.messenger[sendName] = deprecate(Promise.method(applyFn((msg, promise) => bp.middlewares.sendOutgoing(msg) && promise)))\n      bp.messenger[name] = deprecate(applyFn(msg => msg))\n    })\n\n    createConfigFile(bp)\n    UMM(bp) // Initializes Messenger in the UMM\n  },\n\n  ready: function(bp, config) {\n    initializeMessenger(bp, config)\n    .then(() => {\n      incoming(bp, messenger)\n\n      bp.messenger._internal = messenger\n\n      const router = bp.getRouter('botpress-messenger')\n\n      router.get('/config', (req, res) => {\n        res.send(messenger.getConfig())\n      })\n\n      router.post('/config', (req, res) => {\n        messenger.setConfig(req.body)\n        config.saveAll(messenger.getConfig())\n        .then(() => messenger.updateSettings())\n        .then(() => res.sendStatus(200))\n        .catch((err) => {\n          res.status(500).send({ message: err.message })\n        })\n      })\n\n      router.post('/connection', (req, res) => {\n        if (messenger.getConfig().connected) {\n          messenger.disconnect()\n          .then(() => res.sendStatus(200))\n          .catch((err) => res.status(500).send({ message: err.message }))\n        } else {\n          messenger.connect()\n          .then(() => res.sendStatus(200))\n          .catch((err) => res.status(500).send({ message: err.message }))\n        }\n      })\n\n      router.post('/validation', (req, res) => {\n        messenger.sendValidationRequest()\n        .then((json) => {\n          res.send(json)\n        })\n        .catch((err) => {\n          res.status(500).send({ message: err.message })\n        })\n      })\n\n      router.get('/homepage', (req, res) => {\n        const packageJSON = JSON.parse(fs.readFileSync(path.join(__dirname, '../package.json')))\n        res.send({ homepage: packageJSON.homepage })\n      })\n\n      router.get('/users', (req, res)=> {\n        users.getAllUsers()\n        .then((values) => {\n          res.send(values)\n        })\n        .catch((err) => res.status.send(500).send({ message:err.message }))\n      })\n\n      router.post('/remove_payment_tester', (req, res) => {\n        messenger.deletePaymentTester(req.body.payment_tester)\n          .then((json)=> {\n            res.send(json)\n          })\n          .catch((err) => {\n            res.status(500).send({ message: err.message })\n          })\n      })\n\n      router.get('/facebook_page', (req, res) => {\n        messenger._getPage()\n          .then((json) => {\n            res.send(json)\n          })\n          .catch((err) => {\n            res.status(500).send({ message: err.message })\n          })\n      })\n\n    })\n\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"botpress-version-manager\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress-version-manager\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"path\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"path\"\n// module id = 3\n// module chunks = 0","module.exports = require(\"fs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fs\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"uuid\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"uuid\"\n// module id = 6\n// module chunks = 0","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 7\n// module chunks = 0","/**\n * Messenger\n *\n * This file contains one class Messenger, which in charge of communication between\n * botpress and fb messenger.\n *\n */\n\nconst Promise = require('bluebird')\nconst EventEmitter = require('eventemitter2')\nconst crypto = require('crypto')\nconst fetch = require('node-fetch')\nconst _ = require('lodash')\nconst bodyParser = require('body-parser')\n\nimport DB from './db'\n\nfetch.promise = Promise\n\nconst normalizeString = function(str) {\n  return str.replace(/[^a-zA-Z0-9]+/g, '').toUpperCase()\n}\n\nlet db = null\n\nclass Messenger extends EventEmitter {\n  constructor(bp, config) {\n    super()\n    if (!bp || !config) {\n      throw new Error('You need to specify botpress and config')\n    }\n\n    this.setConfig(config)\n    this.bp = bp\n\n    bp.db.get()\n    .then(k => {\n      db = DB(k)\n      db.initialize()\n    })\n\n    this.app = bp.getRouter('botpress-messenger', {\n      'bodyParser.json': false,\n      'auth': req => !/\\/webhook/i.test(req.originalUrl)\n    })\n\n    this.app.use(bodyParser.json({\n      verify: this._verifyRequestSignature.bind(this)\n    }))\n\n    this._initWebhook()\n  }\n\n  setConfig(config) {\n    this.config = Object.assign({}, this.config, config)\n  }\n\n  getConfig() {\n    return this.config\n  }\n\n  getConfigErrors() {\n    const errors = []\n    const required = ['applicationID', 'accessToken', 'appSecret', 'hostname', 'verifyToken']\n\n    _.forEach(this.config, (value, key) => {\n      if (_.includes(required, key) && (_.isNil(value) || _.isEmpty(value))) {\n        errors.push({\n          key: key,\n          message: `Configuration is incomplete, ${key} needs to be defined. See \"./botpress-messenger.config.yml\".`\n        })\n      }\n    })\n\n    return errors\n  }\n\n  connect() {\n    return this._setupNewWebhook()\n    .then(() => this._subscribePage())\n  }\n\n  disconnect() {\n    return this._unsubscribePage()\n  }\n\n  sendTextMessage(recipientId, text, quickReplies, options) {\n    const message = { text }\n    const formattedQuickReplies = this._formatQuickReplies(quickReplies)\n    if (formattedQuickReplies && formattedQuickReplies.length > 0) {\n      message.quick_replies = formattedQuickReplies\n    }\n    return this.sendMessage(recipientId, message, options)\n  }\n\n  sendButtonTemplate(recipientId, text, buttons, options) {\n    const payload = {\n      template_type: 'button',\n      text\n    }\n    const formattedButtons = this._formatButtons(buttons)\n    payload.buttons = formattedButtons\n    return this.sendTemplate(recipientId, payload, options)\n  }\n\n  sendGenericTemplate(recipientId, elements, options) {\n    const payload = {\n      template_type: 'generic',\n      elements\n    }\n    return this.sendTemplate(recipientId, payload, options)\n  }\n\n  sendTemplate(recipientId, payload, options) {\n    const message = {\n      attachment: {\n        type: 'template',\n        payload\n      }\n    }\n    return this.sendMessage(recipientId, message, options)\n  }\n\n  async sendAttachment(recipientId, type, url, quickReplies, options) {\n    const message = {\n      attachment: {\n        type: type,\n        payload: {}\n      }\n    }\n\n    if (options.isReusable && _.isBoolean(options.isReusable)) {\n      message.attachment.payload.is_reusable = options.isReusable\n    }\n\n    if (options.attachmentId){\n      message.attachment.payload = {\n        attachment_id: options.attachmentId,\n      }\n    } else if (options.isReusable && await db.hasAttachment(url)) {\n      const attachmentId = await db.getAttachment(url)\n\n      message.attachment.payload = {\n        attachment_id: attachmentId\n      }\n    } else {\n      message.attachment.payload.url = url\n    }\n\n    const formattedQuickReplies = this._formatQuickReplies(quickReplies)\n    if (formattedQuickReplies && formattedQuickReplies.length > 0) {\n      message.quick_replies = formattedQuickReplies\n    }\n\n    return this.sendMessage(recipientId, message, options)\n    .then(res => {\n      if (res && res.attachment_id) {\n        db.addAttachment(url, res.attachment_id)\n      }\n    })\n  }\n\n  sendAction(recipientId, action) {\n    return this.sendRequest({\n      recipient: {\n        id: recipientId\n      },\n      sender_action: action\n    })\n  }\n\n  sendMessage(recipientId, message, options) {\n    const req = () => this.sendRequest({\n      recipient: {\n        id: recipientId\n      },\n      message\n    })\n\n    if (options && options.typing) {\n      const autoTimeout = (message && message.text) ? 500 + message.text.length * 10 : 1000\n      const timeout = (typeof options.typing === 'number') ? options.typing : autoTimeout\n      return this.sendTypingIndicator(recipientId, timeout).then(req)\n    }\n\n    return req()\n  }\n\n  sendValidationRequest() {\n    const applicationID = this.config.applicationID\n    const accessToken = this.config.accessToken\n\n    return fetch(`https://graph.facebook.com/v2.7/${applicationID}/subscriptions_sample`, {\n      method: 'POST',\n      headers: {'Content-Type': 'application/json'},\n      body: JSON.stringify({\n        object_id: applicationID,\n        object: 'page',\n        field: 'messages',\n        custom_fields: { page_id: applicationID },\n        access_token: accessToken\n      })\n    })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n  }\n\n  sendRequest(body, endpoint, method) {\n    endpoint = endpoint || 'messages'\n    method = method || 'POST'\n\n    const url = `https://graph.facebook.com/v2.7/me/${endpoint}`\n    return fetch(`${url}?access_token=${this.config.accessToken}`, {\n      method,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(body)\n    })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .then(json => {\n      this._handleEvent('raw_send_request', { url, token: this.config.accessToken, body, endpoint, method, response: json })\n      return json\n    })\n  }\n\n  sendThreadRequest(body, method) {\n    return this.sendRequest(body, 'thread_settings', method)\n  }\n\n  sendTypingIndicator(recipientId, milliseconds) {\n    let timeout = !milliseconds || isNaN(milliseconds) ? 0 : milliseconds\n    timeout = Math.min(20000, timeout)\n\n    if (milliseconds === true) {\n      timeout = 1000\n    }\n\n    const before = timeout > 0\n      ? Promise.resolve(this.sendAction(recipientId, 'typing_on'))\n      : Promise.resolve(true)\n\n    return before\n    .delay(timeout + 1000)\n    .then(() => this.sendAction(recipientId, 'typing_off'))\n  }\n\n  getUserProfile(userId) {\n    const url = `https://graph.facebook.com/v2.7/${userId}?fields=first_name,last_name,profile_pic,locale,timezone,gender&access_token=${this.config.accessToken}`\n    return fetch(url)\n      .then(this._handleFacebookResponse)\n      .then(res => res.json())\n      .catch(err => console.log(`Error getting user profile: ${err}`))\n  }\n\n  createTargetAudienceSetting() {\n    var setting = { target_audience: {} }\n\n    switch(this.config.targetAudience){\n      case 'openToAll':\n        setting.target_audience.audience_type = 'all'\n        break;\n      case 'openToSome':\n        var countriesWhitelist = this.config.targetAudienceOpenToSome.split(/\\, ?/g);\n        setting.target_audience.audience_type = 'custom'\n        setting.target_audience.countries = {\n          whitelist: countriesWhitelist\n        }\n        break;\n      case 'closeToSome':\n        setting.target_audience.audience_type = 'custom'\n        var countriesBlacklist = this.config.targetAudienceCloseToSome.split(/\\, ?/g);\n        setting.target_audience.countries = {\n          blacklist: countriesBlacklist\n        }\n        break;\n      case 'closeToAll':\n        setting.target_audience.audience_type = 'none'\n        break;\n    }\n\n    return setting;\n  }\n\n  setTargetAudience() {\n    const url = `https://graph.facebook.com/v2.7/me/messenger_profile?access_token=${this.config.accessToken}`\n    var setting = this.createTargetAudienceSetting();\n\n    return this.sendRequest(setting, 'messenger_profile', 'POST')\n  }\n\n  async setWhitelistedDomains(domains, chatExtensionHomeUrl) {\n    // the chat extension home url is controlled by a different state value\n    // but it still needs to be whitelisted.  It's also possible that this url\n    // has already been whitelisted for another purpose\n    // so we need to check:\n    //    a) that it's set, and\n    //    b) that it's not already in the list\n    if(!_.isEmpty(chatExtensionHomeUrl)) {\n      if(domains.indexOf(chatExtensionHomeUrl) == -1) {\n        domains.push(chatExtensionHomeUrl);\n      }\n    }\n\n    const url = `https://graph.facebook.com/v2.6/me/messenger_profile?access_token=${this.config.accessToken}`\n\n    await fetch(url, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } })\n    .then(this._handleFacebookResponse)\n\n    if (domains.length === 0) {\n      return\n    }\n\n    return fetch(url, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        setting_type: 'domain_whitelisting',\n        whitelisted_domains: domains,\n        domain_action_type: 'add'\n      })\n    })\n    .then(this._handleFacebookResponse)\n  }\n\n  setGreetingText(text) {\n    return this.sendThreadRequest({\n      setting_type: 'greeting',\n      greeting: { text }\n    })\n  }\n\n  deleteGreetingText() {\n    return this.sendThreadRequest({\n      setting_type: 'greeting'\n    }, 'DELETE')\n  }\n\n  setGetStartedButton(action) {\n    const payload = (typeof action === 'string') ? action : 'GET_STARTED'\n    if (typeof action === 'function') {\n      this.on(`postback:${payload}`, action)\n    }\n    return this.sendThreadRequest({\n      setting_type: 'call_to_actions',\n      thread_state: 'new_thread',\n      call_to_actions: [ { payload } ]\n    })\n  }\n\n  deleteGetStartedButton() {\n    return this.sendThreadRequest({\n      setting_type: 'call_to_actions',\n      thread_state: 'new_thread'\n    }, 'DELETE')\n  }\n\n  setPersistentMenu(buttons, composerInputDisabled) {\n    const formattedButtons = this._formatButtons(buttons)\n    return this.sendRequest({\n      persistent_menu: [\n        { // TODO Allow setting multiple menues for different locales\n          locale: 'default',\n          composer_input_disabled: composerInputDisabled,\n          call_to_actions: buttons\n        }\n      ]\n    }, 'messenger_profile')\n  }\n\n  deletePersistentMenu() {\n    return this.sendRequest({\n      \"fields\":[ \"persistent_menu\" ]\n    }, 'messenger_profile', 'DELETE')\n  }\n\n  /**\n   * Create the settings to add a new chat extension home url\n   *\n   * Within the context of this app the \"show_share\" is a boolean\n   * but Facebook either wants a\n   */\n  createChatExtensionHomeUrlSetting(home_url, in_test, show_share) {\n    var show_string = \"hide\"\n    if (show_share == true){\n      show_string = \"show\"\n    }\n\n    return {\n      \"home_url\" : {\n        \"url\": home_url,\n        \"webview_height_ratio\": \"tall\",\n        \"in_test\":in_test,\n        \"webview_share_button\": show_string\n      }\n    }\n  }\n\n  deleteChatExtensionHomeUrlSetting() {\n    return {\n      \"fields\": [\n        \"home_url\"\n      ]\n    }\n  }\n\n  deleteChatExtensionHomeUrl() {\n    const url = `https://graph.facebook.com/v2.7/me/messenger_profile?access_token=${this.config.accessToken}`\n    var setting = this.deleteChatExtensionHomeUrlSetting();\n\n    return this.sendRequest(setting, 'messenger_profile', 'DELETE')\n  }\n\n  setChatExtensionHomeUrl(home_url, in_test, show_share) {\n    const url = `https://graph.facebook.com/v2.7/me/messenger_profile?access_token=${this.config.accessToken}`\n\n    var setting = this.createChatExtensionHomeUrlSetting(home_url, in_test, show_share)\n\n    return this.sendRequest(setting, 'messenger_profile', 'POST')\n  }\n\n  // add and delete payment testers from application\n  // https://developers.facebook.com/docs/messenger-platform/thread-settings/payment#payment_test_users\n  deletePaymentTesterSetting(tester) {\n    return {\n      \"setting_type\": \"payment\",\n      \"payment_dev_mode_action\": \"REMOVE\",\n      \"payment_testers\": [tester]\n    }\n  }\n  createPaymentTesterSetting() {\n    return {\n      \"setting_type\": \"payment\",\n      \"payment_dev_mode_action\": \"ADD\",\n      \"payment_testers\": this.config.paymentTesters\n    }\n  }\n\n  setPaymentTesters() {\n    if(this.config.paymentTesters.length == 0) {\n      return\n    }\n    const setting = this.createPaymentTesterSetting()\n    return this.sendThreadRequest(setting, \"POST\")\n\n  }\n  deletePaymentTester(tester) {\n    const setting = this.deletePaymentTesterSetting(tester)\n    return this.sendThreadRequest(setting, \"POST\")\n  }\n\n  getPageDetails(){\n    return this._getPage()\n  }\n\n  updateSettings() {\n    const updateGetStarted = () => this.config.displayGetStarted\n      ? this.setGetStartedButton()\n      : this.deleteGetStartedButton()\n\n    const updateGreetingText = () => _.isEmpty(this.config.greetingMessage)\n      ? this.deleteGreetingText()\n      : this.setGreetingText(this.config.greetingMessage)\n\n    const items = this._reformatPersistentMenuItems(this.config.persistentMenuItems)\n    const updatePersistentMenu = () => this.config.persistentMenu\n      ? this.setPersistentMenu(items, this.config.composerInputDisabled)\n      : this.deletePersistentMenu()\n\n    const updateTargetAudience = () => this.setTargetAudience()\n\n    const updateTrustedDomains = () => this.setWhitelistedDomains(this.config.trustedDomains, this.config.chatExtensionHomeUrl)\n\n    const updateChatExtensionHomeUrl = () => _.isEmpty(this.config.chatExtensionHomeUrl) ? this.deleteChatExtensionHomeUrl() : this.setChatExtensionHomeUrl(this.config.chatExtensionHomeUrl, this.config.chatExtensionInTest, this.config.chatExtensionShowShareButton)\n\n    const updatePaymentTesters = () => this.setPaymentTesters()\n\n    let thrown = false\n    const contextifyError = (context) => (err) => {\n      if (thrown) throw err\n      const message = `Error setting ${context}\\n${err.message}`\n      thrown = true\n      throw new Error(message)\n    }\n\n    return updateGetStarted()\n    .catch(contextifyError('get started'))\n    .then(updateGreetingText)\n    .catch(contextifyError('greeting text'))\n    .then(updatePersistentMenu)\n    .catch(contextifyError('persistent menu'))\n    .then(updateTargetAudience)\n    .catch(contextifyError('target audience'))\n    .then(updateTrustedDomains)\n    .catch(contextifyError('trusted domains'))\n    .then(updateChatExtensionHomeUrl)\n    .catch(contextifyError('chat extensions'))\n    .then(updatePaymentTesters)\n    .catch(contextifyError('payment testers'))\n\n  }\n\n  module(factory) {\n    return factory.apply(this, [ this ])\n  }\n\n  _formatButtons(buttons) {\n    return buttons && buttons.map((button) => {\n      if (typeof button === 'string') {\n        return {\n          type: 'postback',\n          title: button,\n          payload: 'BUTTON_' + normalizeString(button)\n        }\n      } else if (button && button.title) {\n        return button\n      }\n      return {}\n    })\n  }\n\n  _formatQuickReplies(quickReplies) {\n    return quickReplies && quickReplies.map((reply) => {\n      if (typeof reply === 'string') {\n        return {\n          content_type: 'text',\n          title: reply,\n          payload: 'QR_' + normalizeString(reply)\n        }\n      } else if (reply && reply.title) {\n        return {\n          content_type: reply.content_type || 'text',\n          title: reply.title,\n          payload: reply.payload || 'QR_' + normalizeString(reply.title),\n          image_url: reply.image_url\n        }\n      }\n      return reply\n    })\n  }\n\n  _handleEvent(type, event) {\n    this.emit(type, event)\n  }\n\n  _handleMessageEvent(event) {\n    const text = event.message.text\n    if (!text) { return }\n\n    this._handleEvent('message', event)\n\n    if (event.message && this.config.automaticallyMarkAsRead) {\n      this.sendAction(event.sender.id, 'mark_seen')\n    }\n  }\n\n  _handleAttachmentEvent(event) {\n    this._handleEvent('attachment', event)\n\n    if (event.message && this.config.automaticallyMarkAsRead) {\n      this.sendAction(event.sender.id, 'mark_seen')\n    }\n  }\n\n  _handlePostbackEvent(event) {\n    const payload = event.postback.payload\n    if (payload) {\n      this._handleEvent(`postback:${payload}`, event)\n    }\n    this._handleEvent('postback', event)\n  }\n\n  _handleQuickReplyEvent(event) {\n    const payload = event.message.quick_reply && event.message.quick_reply.payload\n    if (payload) {\n      this._handleEvent(`quick_reply:${payload}`, event)\n    }\n    this._handleEvent('quick_reply', event)\n\n    if (event.message && this.config.automaticallyMarkAsRead) {\n      this.sendAction(event.sender.id, 'mark_seen')\n    }\n  }\n\n  _handleFacebookResponse(res) {\n    if (!res) return\n\n    if (res.status < 400) {\n      return res\n    }\n\n    let errorMessage = 'An error has been returned by Facebook API.'\n    errorMessage += '\\nStatus: ' + res.status + ' (' + res.statusText + ')'\n\n    return Promise.resolve(true)\n    .then(() => res.json())\n    .then(json => {\n      errorMessage += '\\n' + json.error.message\n    })\n    .finally(() => {\n      throw new Error(errorMessage)\n    })\n  }\n\n  _initWebhook() {\n    this.app.get('/webhook', (req, res) => {\n      if (req.query['hub.mode'] === 'subscribe' && req.query['hub.verify_token'] === this.config.verifyToken) {\n\n        res.status(200).send(req.query['hub.challenge'])\n      } else {\n        console.error('Failed validation. Make sure the validation tokens match.')\n        res.sendStatus(403)\n      }\n    })\n\n    this.app.post('/webhook', (req, res) => {\n      var data = req.body\n      if (data.object !== 'page') {\n        return\n      }\n\n      this._handleEvent('raw_webhook_body', data)\n\n      // Iterate over each entry. There may be multiple if batched.\n      data.entry.forEach((entry) => {\n        if (entry && !entry.messaging) {\n          return\n        }\n        // Iterate over each messaging event\n        entry.messaging.forEach((event) => {\n          if (event.message && event.message.is_echo && !this.config.broadcastEchoes) {\n            return\n          }\n          if (event.message && event.message.text) {\n            if (event.message.quick_reply) {\n              this._handleQuickReplyEvent(event)\n            } else {\n              this._handleMessageEvent(event)\n            }\n          } else if (event.message && event.message.attachments) {\n            this._handleAttachmentEvent(event)\n          } else if (event.postback) {\n            this._handlePostbackEvent(event)\n          } else if (event.delivery) {\n            this._handleEvent('delivery', event)\n          } else if (event.read) {\n            this._handleEvent('read', event)\n          } else if (event.account_linking) {\n            this._handleEvent('account_linking', event)\n          } else if (event.optin) {\n            this._handleEvent('optin', event)\n          } else if (event.referral) {\n            this._handleEvent('referral', event)\n          } else if (event.payment){\n            this._handleEvent('payment', event)\n          }\n          else {\n            console.log('Webhook received unknown event: ', event)\n          }\n        })\n      })\n\n      // Must send back a 200 within 20 seconds or the request will time out.\n      res.sendStatus(200)\n    })\n  }\n\n  _verifyRequestSignature(req, res, buf) {\n    if (!/^\\/webhook/i.test(req.path)) {\n      return\n    }\n\n    var signature = req.headers['x-hub-signature']\n    if (!signature) {\n      throw new Error('Couldn\\'t validate the request signature.')\n    } else {\n      let [, hash] = signature.split('=')\n      var expectedHash = crypto.createHmac('sha1', this.config.appSecret).update(buf).digest('hex')\n\n      if (hash != expectedHash) {\n        throw new Error('Couldn\\'t validate the request signature.')\n      }\n    }\n  }\n\n  _reformatPersistentMenuItems() {\n    if (this.config.persistentMenu && this.config.persistentMenuItems) {\n      return this.config.persistentMenuItems.map((item) => {\n\n        if (item.value && item.type === 'postback') {\n          item.payload = item.value\n          delete item.value\n        } else if (item.value && item.type === 'url') {\n          item.url = item.value\n          item.type = 'web_url'\n          delete item.value\n        }\n        return item\n      })\n    }\n  }\n\n  _setupNewWebhook() {\n    const oAuthUrl = 'https://graph.facebook.com/v2.7/oauth/access_token' +\n      '?client_id=' + this.config.applicationID +\n      '&client_secret=' + this.config.appSecret +\n      '&grant_type=client_credentials'\n\n    const url = `https://graph.facebook.com/v2.7/${this.config.applicationID}/subscriptions?access_token=`\n\n    return fetch(oAuthUrl)\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .then(json => json.access_token)\n    .then(token => fetch(url + token, {\n      method: 'POST',\n      headers: {'Content-Type': 'application/json'},\n      body: JSON.stringify({\n        object: 'page',\n        callback_url: 'https://' + this.config.hostname + '/api/botpress-messenger/webhook',\n        verify_token: this.config.verifyToken,\n        fields: this.config.webhookSubscriptionFields\n      })\n    }))\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n  }\n\n  _subscribePage() {\n    const url = 'https://graph.facebook.com/v2.6/me/subscribed_apps?access_token=' + this.config.accessToken\n\n    return fetch(url, { method: 'POST' })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .catch(err => console.log(err))\n  }\n\n  _unsubscribePage() {\n    const url = 'https://graph.facebook.com/v2.6/me/subscribed_apps?access_token=' + this.config.accessToken\n\n    return fetch(url, { method: 'DELETE' })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .catch(err => console.log(err))\n  }\n\n  _getPage() {\n    const url = 'https://graph.facebook.com/v2.6/me/?access_token=' + this.config.accessToken\n\n    return fetch(url, { method: 'GET' })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .catch(err => console.log(err))\n  }\n\n}\n\nmodule.exports = Messenger\n\n\n\n// WEBPACK FOOTER //\n// ./src/messenger.js","import { DatabaseHelpers } from 'botpress'\n\nvar knex = null\n\nfunction initialize() {\n  if (!knex) {\n    throw new Error('you must initialize the database before')\n  }\n  \n  return DatabaseHelpers(knex).createTableIfNotExists('messenger_attachments', function (table) {\n    table.string('url').primary()\n    table.string('attachment_id')\n  }).then()\n}\n\nfunction addAttachment(url, attachment_id) {\n  return knex('messenger_attachments')\n  .insert({ url, attachment_id })\n  .then().get(0)\n}\n\nfunction getAttachment(url) {\n  return knex('messenger_attachments')\n  .where('url', url)\n  .select('attachment_id')\n  .then().get(0)\n  .then(ret => {\n    return ret && ret.attachment_id\n  })\n}\n\nfunction hasAttachment(url) {\n  return knex('messenger_attachments')\n  .where('url', url)\n  .count('url as count')\n  .then(ret => {\n    return ret && ret[0] && ret[0].count === 1\n  })\n}\n\nmodule.exports = (k) => {\n  knex = k\n  return { initialize, addAttachment, getAttachment, hasAttachment }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/db.js","module.exports = require(\"botpress\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress\"\n// module id = 10\n// module chunks = 0","module.exports = require(\"eventemitter2\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"eventemitter2\"\n// module id = 11\n// module chunks = 0","module.exports = require(\"crypto\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"crypto\"\n// module id = 12\n// module chunks = 0","module.exports = require(\"node-fetch\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"node-fetch\"\n// module id = 13\n// module chunks = 0","module.exports = require(\"body-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"body-parser\"\n// module id = 14\n// module chunks = 0","import _ from 'lodash'\nimport Promise from 'bluebird'\nimport outgoing from './outgoing'\n\nconst create = obj => {\n  let resolve = null\n  let reject = null\n  const promise = new Promise((r, rj) => {\n    resolve = r\n    reject = rj\n  })\n\n  const messageId = new Date().toISOString() + Math.random()\n  \n  const newEvent = Object.assign({\n    _promise: promise,\n    _resolve: resolve,\n    _reject: reject,\n    __id: messageId\n  }, obj)\n\n  outgoing.pending[messageId] = {\n    event: newEvent,\n    resolve: resolve,\n    reject: reject\n  }\n\n  return newEvent\n}\n\nconst validateUserId = (userId) => {\n  if (!/[0-9]+/.test(userId)) {\n    throw new Error('Invalid userId')\n  }\n}\n\nconst validateText = (text) => {\n  if (typeof(text) !== 'string' || text.length > 300) {\n    throw new Error('Text must be a string less than 300 chars.')\n  }\n}\n\nconst validateQuickReplies = (quick_replies) => {\n  if (!_.isArray(quick_replies)) {\n    throw new Error('quick_replies must be an array')\n  }\n\n  _.forEach(quick_replies, validateQuickReply)\n}\n\nconst validateQuickReply = (quick_reply) => {\n  if (typeof(quick_reply) !== 'string') {\n    if (!quick_reply || typeof(quick_reply.title) !== 'string') {\n      throw new Error('Expected quick_reply to be a string or an object' +\n        'with a title.')\n    }\n  }\n}\n\nconst validateTyping = (typing) => {\n  if (!_.isBoolean(typing) && !_.isNumber(typing)) {\n    throw new Error('Expected typing to be a boolean of a number')\n  }\n}\n\nconst validateAttachmentType = (type) => {\n  if (typeof(type) !== 'string') {\n    throw new Error('Expected attachment type to be a text')\n  }\n\n  if (!_.includes(['image', 'video', 'audio', 'file'], type.toLowerCase())) {\n    throw new Error('Invalid attachment type')\n  }\n}\n\nconst validateUrl = (url) => {\n  if (typeof(url) !== 'string') {\n    throw new Error('Expected URL to be a string')\n  }\n}\n\nconst validateTemplatePayload = (payload) => {\n  if (!_.isPlainObject(payload)) {\n    throw new Error('Template payload must be a plain object')\n  }\n\n  if (typeof(payload.template_type) !== 'string') {\n    throw new Error('\"template_type\" must be set')\n  }\n}\n\nconst validatePersistentMenu = (elements) => {\n  if (!_.isArray(elements)) {\n    throw new Error('Expected elements to be an array')\n  }\n\n  _.forEach(elements, (element) => {\n    if (!_.isPlainObject(element)) {\n      throw new Error('Expected element to be a plain object')\n    }\n  })\n}\n\nconst createText = (userId, text, options) => {\n  validateUserId(userId)\n  validateText(text)\n\n  if (options && options.quick_replies) {\n    validateQuickReplies(options.quick_replies)\n  }\n\n  if (options && options.typing) {\n    validateTyping(options.typing)\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'text',\n    text: text,\n    raw: {\n      to: userId,\n      message: text,\n      typing: (options && options.typing),\n      quick_replies: options && options.quick_replies,\n      waitRead: options && options.waitRead,\n      waitDelivery: options && options.waitDelivery\n    }\n  })\n}\n\nconst createAttachment = (userId, type, url, options) => {\n  validateUserId(userId)\n  validateAttachmentType(type)\n  \n  if ( _.isNull(url) && !(options && options.attachmentId) ) {\n    throw new Error('If URL is null, you must pass an attachment_id on options object')\n  }\n  else if ( options && options.attachmentId ) {\n    validateText(options.attachmentId)\n  }\n  else {\n    validateUrl(url)\n  }\n\n  if (options && options.quick_replies) {\n    validateQuickReplies(options.quick_replies)\n  }\n\n  if (options && options.typing) {\n    validateTyping(options.typing)\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'attachment',\n    text: 'Attachment (' + type + ') : ' + url,\n    raw: {\n      to: userId,\n      type: type,\n      url: url,\n      isReusable: (options && options.isReusable),\n      attachmentId: (options && options.attachmentId),\n      typing: (options && options.typing),\n      quick_replies: options && options.quick_replies,\n      waitRead: options && options.waitRead,\n      waitDelivery: options && options.waitDelivery\n    }\n  })\n}\n\nconst createTemplate = (userId, payload, options) => {\n  validateUserId(userId)\n  validateTemplatePayload(payload)\n\n  if (options && options.typing) {\n    validateTyping(options.typing)\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'template',\n    text: 'Template (' + payload.template_type + ')',\n    raw: {\n      to: userId,\n      payload: payload,\n      typing: (options && options.typing),\n      waitRead: options && options.waitRead,\n      waitDelivery: options && options.waitDelivery\n    }\n  })\n}\n\nconst createTyping = (userId, typing) => {\n  validateUserId(userId)\n  validateTyping(typing)\n\n  return create({\n    platform: 'facebook',\n    type: 'typing',\n    text: 'Typing: ' + typing,\n    raw: {\n      to: userId,\n      typing: typing\n    }\n  })\n}\n\nconst createSeen = (userId) => {\n  validateUserId(userId)\n\n  return create({\n    platform: 'facebook',\n    type: 'seen',\n    text: 'Mark as seen',\n    raw: {\n      to: userId\n    }\n  })\n}\n\nconst createPersistentMenu = (elements) => {\n  if (!elements) {\n    return create({\n      platform: 'facebook',\n      type: 'persistent_menu',\n      text: 'Delete the persistent menu',\n      raw: {\n        delete: true\n      }\n    })\n  }\n\n  validatePersistentMenu(elements)\n  return create({\n    platform: 'facebook',\n    type: 'persistent_menu',\n    text: 'Set persistent menu: ' + elements.length + ' items',\n    raw: {\n      delete: false,\n      elements: elements\n    }\n  })\n}\n\nconst createGreetingText = (text) => {\n  if (text && text.length > 160) {\n    throw new Error('Greeting text must be less than 160 chars')\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'greeting_text',\n    text: 'Set greeting text: ' + text,\n    raw: {\n      text: text\n    }\n  })\n}\n\nconst createGetStarted = (postback) => {\n  return create({\n    platform: 'facebook',\n    type: 'get_started',\n    text: 'Setting get started button: ' + !!postback,\n    raw: {\n      enabled: !!postback,\n      postback: postback\n    }\n  })\n}\n\nconst createWhitelistedDomains = (domains) => {\n  if (domains && !_.every(domains, _.isString)) {\n    throw new Error('Expected domains to be a list of string')\n  }\n\n  return create({\n    platform: 'facebook',\n    type: 'whitelisted_domains',\n    text: 'Setting whitelisted domains',\n    raw: {\n      domains: domains\n    }\n  })\n}\n\nmodule.exports = {\n  createText,\n  createAttachment,\n  createTemplate,\n  createTyping,\n  createSeen,\n  createGetStarted,\n  createPersistentMenu,\n  createGreetingText,\n  createWhitelistedDomains\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/actions.js","const handlePromise = (next, promise) => {\n  return promise.then(res => {\n    next()\n    return res\n  })\n  .catch(err => {\n    next(err)\n    throw err\n  })\n}\n\nconst handleText = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendTextMessage(\n    event.raw.to,\n    event.raw.message,\n    event.raw.quick_replies,\n    event.raw))\n}\n\nconst handleAttachment = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendAttachment(\n    event.raw.to,\n    event.raw.type,\n    event.raw.url,\n    event.raw.quick_replies,\n    event.raw))\n}\n\nconst handleTemplate = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendTemplate(\n    event.raw.to,\n    event.raw.payload,\n    event.raw))\n}\n\nconst handleTyping = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendTypingIndicator(\n    event.raw.to,\n    event.raw.typing))\n}\n\nconst handleSeen = (event, next, messenger) => {\n  return handlePromise(next, \n    messenger.sendAction(event.raw.to, 'mark_seen'))\n}\n\nconst handleGetStarted = (event, next, messenger) => {\n  if (event.raw.enabled) {\n    return handlePromise(next, \n      messenger.setGetStartedButton(event.raw.postback))\n  } else {\n    return handlePromise(next, messenger.deleteGetStartedButton())\n  }\n}\n\nconst handlePersistentMenu = (event, next, messenger) => {\n  if (event.raw.delete) {\n    return handlePromise(next, messenger.deletePersistentMenu())\n  } else {\n    return handlePromise(next, \n      messenger.setPersistentMenu(event.raw.elements))\n  }\n}\n\nconst handleGreetingText = (event, next, messenger) => {\n  if (event.raw.text) {\n    return handlePromise(next, \n      messenger.setGreetingText(event.raw.text))\n  } else {\n    return handlePromise(next, messenger.deleteGreetingText(event.raw.text))\n  }\n}\n\nconst handleWhitelistedDomains = (event, next, messenger) => {\n  return handlePromise(next, \n    messenger.setWhitelistedDomains(event.raw.domains))\n}\n\nmodule.exports = {\n  'text': handleText,\n  'attachment': handleAttachment,\n  'template': handleTemplate,\n  'typing': handleTyping,\n  'seen': handleSeen,\n  'greeting_text': handleGreetingText,\n  'persistent_menu': handlePersistentMenu,\n  'whitelisted_domains': handleWhitelistedDomains,\n  'get_started': handleGetStarted,\n  pending: {}\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/outgoing.js","import LRU from 'lru-cache'\n\nimport Users from './users'\nimport outgoing from './outgoing'\nimport _ from 'lodash'\n\nmodule.exports = (bp, messenger) => {\n\n  const users = Users(bp, messenger)\n\n  const messagesCache = LRU({\n    max: 10000,\n    maxAge: 60 * 60 * 1000\n  })\n\n  const preprocessEvent = payload => {\n    const userId = payload.sender.id\n    const mid = payload.message && payload.message.mid\n\n    if (mid && !messagesCache.has(mid)) {\n      // We already processed this message\n      payload.alreadyProcessed = true\n    } else {\n      // Mark it as processed\n      messagesCache.set(mid, true)\n    }\n\n    return users.getOrFetchUserProfile(userId)\n  }\n\n  messenger.on('message', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      // push the message to the incoming middleware\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'message',\n        user: profile,\n        text: e.message.text,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('attachment', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'attachments',\n        user: profile,\n        text: e.message.attachments.length + ' attachments',\n        raw: e\n      })\n      e.message.attachments.forEach(att => {\n        bp.middlewares.sendIncoming({\n          platform: 'facebook',\n          type: att.type,\n          user: profile,\n          text: att.payload.url ?\n            att.payload.url\n            : JSON.stringify(att.payload),\n          raw: att\n        })\n      })\n    })\n  })\n\n  messenger.on('postback', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'postback',\n        user: profile,\n        text: e.postback.payload,\n        raw: e\n      })\n\n      if (e.postback.payload === 'GET_STARTED') {\n        const mConfig = messenger.getConfig()\n\n        if (mConfig.displayGetStarted && mConfig.autoResponseOption == 'autoResponseText') {\n          bp.messenger.sendText(profile.id, mConfig.autoResponseText)\n        }\n        \n        if (mConfig.displayGetStarted && mConfig.autoResponseOption == 'autoResponsePostback') {\n          bp.middlewares.sendIncoming({\n            platform: 'facebook',\n            type: 'postback',\n            user: profile,\n            text: mConfig.autoResponsePostback,\n            raw: e\n          })\n        }\n      }\n    })\n  })\n\n  messenger.on('quick_reply', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'quick_reply',\n        user: profile,\n        text: e.message.quick_reply.payload,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('delivery', e => {\n\n    _.values(outgoing.pending).forEach(pending => {\n      const recipient = pending.event.raw.to\n      if (e.sender.id === recipient && pending.event.raw.waitDelivery) {\n        if (_.includes(e.delivery.mids, pending.mid)) {\n          pending.resolve(e)\n          delete outgoing.pending[pending.event.__id]\n        }\n      }\n    })\n\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'delivery',\n        user: profile,\n        text: e.delivery.watermark.toString(),\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('read', e => {\n    _.values(outgoing.pending).forEach(pending => {\n      const recipient = pending.event.raw.to\n      if (e.sender.id === recipient) {\n        if (pending.event.raw.waitRead\n          && pending.timestamp\n          && pending.timestamp <= e.read.watermark) {\n            pending.resolve(e)\n            delete outgoing.pending[pending.event.__id]\n        }\n      }\n    })\n\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'read',\n        user: profile,\n        text: e.read.watermark.toString(),\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('account_linking', () => {\n    bp.logger.warn('[messenger] ACCOUNT_LINKING NOT IMPLEMENTED, Your pull requests are welcome :)')\n  })\n\n  messenger.on('optin', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'optin',\n        user: profile,\n        text: e.optin.ref,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('referral', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'referral',\n        user: profile,\n        text: e.referral.ref,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('payment', e=> {\n    preprocessEvent(e)\n    .then(profile=> {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'payment',\n        text: 'payment',\n        user: profile,\n        payment: e.payment,\n        raw: e\n      })\n    })\n  })\n\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/incoming.js","module.exports = require(\"lru-cache\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lru-cache\"\n// module id = 18\n// module chunks = 0","const _ = require('lodash')\n\nmodule.exports = function(bp, messenger) {\n\n  function profileToDbEntry(profile) {\n    return {\n      id: profile.id,\n      platform: 'facebook',\n      gender: profile.gender,\n      timezone: profile.timezone,\n      locale: profile.locale,\n      picture_url: profile.profile_pic,\n      first_name: profile.first_name,\n      last_name: profile.last_name\n    }\n  }\n\n  function dbEntryToProfile(db) {\n    return {\n      gender: db.gender,\n      timezone: db.timezone,\n      locale: db.locale,\n      profile_pic: db.picture_url,\n      first_name: db.first_name,\n      last_name: db.last_name,\n      id: db.userId\n    }\n  }\n\n  async function getOrFetchUserProfile(userId) {\n    const knex = await bp.db.get()\n\n    const user = await knex('users')\n      .where({ platform: 'facebook', 'userId': userId })\n      .then().get(0).then()\n\n    if (user) {\n      return dbEntryToProfile(user)\n    }\n\n    const profile = Object.assign(await messenger.getUserProfile(userId), { id: userId })\n    await bp.db.saveUser(profileToDbEntry(profile))\n\n    return profile\n  }\n\n  async function getAllUsers() {\n    const knex = await bp.db.get()\n\n    const users = await knex('users')\n      .where({ platform: 'facebook' })\n      .then()\n\n    return (users || []).map(dbEntryToProfile)\n  }\n\n  return { getOrFetchUserProfile, getAllUsers }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/users.js","import util from 'util'\nimport _ from 'lodash'\n\nimport actions from './actions'\n\nconst QUICK_REPLY_PAYLOAD = /\\<(.+)\\>\\s(.+)/i\n\nfunction processButtons(buttons, blocName) {\n  return processQuickReplies(buttons, blocName).map(button => {\n    if (button.payload && button.title && _.isNil(button.type)) {\n      return Object.assign(button, { type: 'postback' })\n    }\n\n    return button\n  })\n}\n\nfunction processQuickReplies(qrs, blocName) {\n  if (!_.isArray(qrs)) {\n    throw new Error('Expected quick_replies to be an array')\n  }\n\n  return qrs.map(qr => {\n    if (_.isString(qr) && QUICK_REPLY_PAYLOAD.test(qr)) {\n      let [, payload, text] = QUICK_REPLY_PAYLOAD.exec(qr)\n      \n      // <.HELLO> becomes <BLOCNAME.HELLO>\n      if (payload.startsWith('.')) {\n        payload = blocName + payload\n      }\n\n      return {\n        title: text,\n        payload: payload.toUpperCase()\n      }\n    }\n\n    return qr\n  })\n}\n\nfunction amendButtons(obj, blocName) {\n  if (!_.isPlainObject(obj)) {\n    return obj\n  }\n\n  return _.mapValues(obj, (value, key) => {\n    if (_.isPlainObject(value)) {\n      return amendButtons(value, blocName)\n    } else if (_.isArray(value)) {\n      if (key === 'buttons') {\n        return amendButtons(processButtons(value, blocName))\n      }\n      return value.map(v => amendButtons(v, blocName))\n    } else {\n      return value\n    }\n  })\n}\n\nfunction getUserId(event) {\n  let userId = _.get(event, 'user.userId')\n    || _.get(event, 'raw.userId')\n    || _.get(event, 'userId')\n    || _.get(event, 'raw.from')\n    || _.get(event, 'user.id')\n    || _.get(event, 'raw.user.id')\n\n  if (!userId) {\n    throw new Error('Could not find userId in the incoming event.')\n  }\n\n  if (userId.startsWith('facebook:')) {\n    return userId.substr('facebook:'.length)\n  }\n\n  return userId\n}\n\nfunction processOutgoing({ event, blocName, instruction }) {\n  const ins = Object.assign({}, instruction) // Create a shallow copy of the instruction\n\n  ////////\n  // PRE-PROCESSING\n  ////////\n  \n  const optionsList = [\n    'quick_replies', \n    'waitRead', \n    'waitDelivery', \n    'typing', \n    'tag',\n    '__platformSpecific',\n    'on'\n  ]\n\n  const options = _.pick(instruction, optionsList)\n  \n  for (let prop of optionsList) {\n    delete ins[prop]\n  }\n\n  if (options.quick_replies) {\n    options.quick_replies = processQuickReplies(options.quick_replies, blocName)\n  }\n\n  /////////\n  /// Processing\n  /////////\n  \n  if (!_.isNil(instruction.template_type)) {\n    const data = amendButtons(ins, blocName)\n    return actions.createTemplate(getUserId(event), data, options)\n  }\n\n  for (let attr of ['image', 'audio', 'video', 'file']) {\n    if (!_.isNil(instruction[attr])) {\n      return actions.createAttachment(getUserId(event), attr, ins[attr], options)\n    }\n  }\n\n  if (!_.isNil(instruction.attachment)) {\n    return actions.createAttachment(\n      getUserId(event),\n      instruction.type || instruction.attachment,\n      ins.url || instruction.attachment,\n      options)\n  }\n\n  if (!_.isNil(instruction.text)) {\n    return actions.createText(getUserId(event), instruction.text, options)\n  }\n\n  ////////////\n  /// POST-PROCESSING\n  ////////////\n  \n  // Nothing to post-process yet\n\n  ////////////\n  /// INVALID INSTRUCTION\n  ////////////\n\n  const strRep = util.inspect(instruction, false, 1)\n  throw new Error(`Unrecognized instruction on Facebook Messenger in bloc '${blocName}': ${strRep}`)\n}\n\n////////////\n/// TEMPLATES\n////////////\n\nfunction getTemplates() {\n  return [\n    {\n      type: 'Text - Single message',\n      template: 'block_name_sm:\\n\\  - Text goes here..'\n    },{\n      type: 'Text - Multiple messages',\n      template: 'block_name_mm:\\n  - Text goes here..(1)\\n  - Text goes here..(2)'\n    },{\n      type: 'Text - Random message',\n      template: 'block_name_rm:\\n  - text:\\n    - Text goes here..(1)\\n    - Text goes here..(2)'\n    },{\n      type: 'Typing - Message with typing',\n      template: 'block_name_bm:\\n  - text: Text goes here..(1)\\n    typing: 1000ms'\n    },{\n      type: 'Text - Quick replies',\n      template: 'block_name_qr:\\n  - text: Text goes here..\\n    quick_replies:\\n    - <POSTBACK_1> Button..(1)\\n    - <POSTBACK_2> Button..(2)'\n    },{\n      type: 'Attachment - Image',\n      template: 'block_image:\\n  - on: facebook\\n    image: https://botpress.io/static/img/nobg_primary_black.png'\n    },{\n      type: 'Attachment - Video',\n      template: 'block_video:\\n  - on: facebook\\n    video: https://www.youtube.com/watch?v=QIokUU4HAKU'\n    },{\n      type: 'Template - Generic',\n      template: 'block_generic:\\n  - on: facebook\\n    template_type: generic\\n    elements:\\n    - title: Welcome to Botpress\\n      image_url: https://botpress.io/static/img/grey_bg_primary.png\\n      subtitle: This is a great building framework\\n      default_action:\\n      - type: web_url\\n        url: https://botpress.io\\n        messenger_extensions: false\\n        webview_height_ratio: tall\\n        fallback_url: https://botpress.io\\n      buttons:\\n      - <BTN_RANDOM> Random cat videos\\n      - type: postback\\n        title: This button gives the same thing\\n        payload: BTN_RANDOM\\n      - type: web_url\\n        url: https://youtube.com/?q=cats\\n        title: Cats on Youtube'\n    },{\n      type: 'Template - Carousel',\n      template: 'block_carousel:\\n  - on: facebook\\n    template_type: generic\\n    elements:\\n    - title: Welcome to Botpress\\n      image_url: https://botpress.io/static/img/grey_bg_primary.png\\n      subtitle: This is a great building framework\\n      default_action:\\n      - type: web_url\\n        url: https://botpress.io\\n        messenger_extensions: false\\n        webview_height_ratio: tall\\n        fallback_url: https://botpress.io\\n      buttons:\\n      - <BTN_RANDOM> Random cat videos\\n      - type: postback\\n        title: This button gives the same thing\\n        payload: BTN_RANDOM\\n      - type: web_url\\n        url: https://youtube.com/?q=cats\\n        title: Cats on Youtube\\n    - title: Bienvenido a Botpress\\n      image_url: https://botpress.io/static/img/nobg_primary_black.png\\n      subtitle: Este es un gran marco de construccin\\n      default_action:\\n      - type: web_url\\n        url: https://botpress.io\\n        messenger_extensions: false\\n        webview_height_ratio: tall\\n        fallback_url: https://botpress.io\\n      buttons:\\n      - <BTN_RANDOM> Videos de perros al azar\\n      - type: postback\\n        title: Este botn da lo mismo\\n        payload: BTN_RANDOM\\n      - type: web_url\\n        url: https://youtube.com/?q=cats\\n        title: Gatos en Youtube'\n    } \n  ]\n}\n\nmodule.exports = bp => {\n  const [umm, registerConnector] = _.at(bp, ['umm', 'umm.registerConnector'])\n\n  umm && registerConnector && registerConnector({\n    platform: 'facebook',\n    processOutgoing: args => processOutgoing(Object.assign({}, args, { bp })),\n    templates: getTemplates()\n  })\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/umm.js","module.exports = require(\"util\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"util\"\n// module id = 21\n// module chunks = 0","module.exports = \"# Edit this file to set the Messenger's module settings programmatically instead of using the GUI\\n# This is regular YAML syntax. See http://docs.ansible.com/ansible/YAMLSyntax.html\\n# You can override these settings with ENV variables. They are commented below.\\n\\n# hostname: \\\"\\\" # MESSENGER_HOST\\n\\n# applicationID: \\\"\\\" # MESSENGER_APP_ID\\n# accessToken: \\\"\\\" # MESSENGER_ACCESS_TOKEN\\n# appSecret: \\\"\\\" # MESSENGER_APP_SECRET\\n\\n# verifyToken: \\\"\\\" # MESSENGER_VERIFY_TOKEN\\n\\n# displayGetStarted: true\\n# greetingMessage: \\\"\\\"\\n\\n# https://developers.facebook.com/docs/messenger-platform/messenger-profile/persistent-menu\\n# persistentMenuItems: []\\n\\n# targetAudience: openToAll\\n# targetAudienceOpenToSome: \\\"\\\"\\n# targetAudienceCloseToSome: \\\"\\\"\\n\\n# trustedDomains: []\\n# autoRespondGetStarted: true\\n\\n# paymentTesters: []\\n\\n# chatExtensionHomeUrl: \\\"\\\"\\n# chatExtensionInTest: true\\n# chatExtensionShowShareButton: false\\n\\nenabled: true\"\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/raw-loader!./src/botpress-messenger.config.yml\n// module id = 22\n// module chunks = 0"],"sourceRoot":""}